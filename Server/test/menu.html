<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bootstrap 5 Navbar Example</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">Navbar</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link activ" href="#">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link activ" href="javascript:drawPDF()">Pdf Draw</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Contact</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <iframe id="pdf" style="width: 100%; height: 1000px;"></iframe>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.min.js"></script>

    <script>

        var page;

        const { PDFDocument, rgb, StandardFonts } = PDFLib;
        const cm = 72 / 2.54;
        var orix = 0, oriy = 0;


        async function drawPDF() {
            const pdfDoc = await PDFDocument.create();
            pdfDoc.registerFontkit(fontkit)
            const fontBytes = await fetch('http://localhost:3000/purchase/NanumBarunGothic.ttf').then((res) => res.arrayBuffer());
            //const customFont = await pdfDoc.embedFont(fontBytes);

            const customFont = await pdfDoc.embedFont(StandardFonts.TimesRoman);

            page = pdfDoc.addPage()

            const {
                width,
                height
            } = page.getSize()

            const fontSize = 14;

            page.setFont(customFont);
            page.setFontSize(fontSize);

            const text = 'This is text in an embedded font!'
            const textSize = 35
            const textWidth = customFont.widthOfTextAtSize(text, textSize)
            const textHeight = customFont.heightAtSize(textSize)

            page.drawText(text, {
                x: 40,
                y: 450,
                size: textSize,
                font: customFont,
                color: rgb(0, 0.53, 0.71),
            })
            page.drawRectangle({
                x: 40,
                y: 450,
                width: textWidth,
                height: textHeight,
                borderColor: rgb(1, 0, 0),
                borderWidth: 1.5,
            })

            drawTextBox(1, 1, 10, 1, rgb(0, 0.53, 0.71), "text", 12, rgb(1, 1, 0), "left");
            //drawTextBox(page, sx, sy, w, h, color, text, fontSize, fcolor);

            setOrigin(1, 26);
            half = width / cm / 2;
            var textwd = customFont.widthOfTextAtSize("Purchase List", fontSize) / cm;
            drawRTexts(half - textwd, 0, 12, rgb(0, 0.53, 0.71), "Purchase List")

            moveDown(2);
            drawRTextBox(0, 0, 10, 1, rgb(0, 0.53, 0.71), "text1", 12, rgb(1, 1, 0), "center");

            moveDown(1);
            drawRTextBox(0, 0, 5, 1, rgb(0, 0.53, 0.71), "text2", 12, rgb(1, 1, 0), "left");
            drawRTextBox(5, 0, 5, 1, rgb(0.4, 0.53, 0.71), "text3", 12, rgb(1, 1, 0), "left");

            moveDown(1);
            drawRTextBox(0, 0, 5, 1, rgb(0, 0.53, 0.71), "text4", 12, rgb(1, 1, 0), "left");
            drawRTextBox(5, 0, 5, 1, rgb(0.4, 0.53, 0.71), "text5", 12, rgb(1, 1, 0), "left");

            const pdfBytes = await pdfDoc.save()
            const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });

            // 생성된 PDF 다운로드
            // const downloadLink = document.createElement('a');
            // downloadLink.href = window.URL.createObjectURL(pdfBlob);
            // downloadLink.download = 'output.pdf';
            // downloadLink.click();
            const pdfDataUri = await pdfDoc.saveAsBase64({ dataUri: true });
            document.getElementById('pdf').src = pdfDataUri;

        }
        setOrigin = (x, y) => {
            //page.moveTo(x * cm, page.getHeight() - y * cm);
            orix = x * cm;
            oriy = y * cm;
            if (page.getHeight() < y * cm)
                oriy = page.getHeight();
        }

        moveDown = (h) => {
            //page.moveDown(h * cm);
            oriy -= h * cm;
        }

        moveUp = (h) => {
            //page.moveDown(h * cm);
            oriy += h * cm;
        }

        drawLines = (s, e, color, thick) => {
            page.drawLine({
                start: {
                    x: s.x,
                    y: s.y
                },
                end: {
                    x: e.x,
                    y: e.y
                },
                color: color, // 선 색상 설정 (RGB)
                thickness: thick, // 선 두께 설정
            });
        }

        drawTexts = (x, y, fontSize, color, text) => {
            page.drawText(text, {
                x: x,
                y: y,
                size: fontSize,
                // font: timesRomanFont,
                color: color,
            })
        }
        drawRTexts = (x, y, fontSize, color, text) => {
            page.drawText(text, {
                x: orix + x * cm,
                y: oriy + y * cm,
                size: fontSize,
                // font: timesRomanFont,
                color: color,
            })
        }

        drawBox = (sx, sy, w, h, color) => {
            page.drawRectangle({
                x: sx * cm,
                y: sy * cm,
                width: w * cm,
                height: h * cm,
                color: color,
                borderColor: rgb(1, 0, 0),
                borderWidth: 1.5,
            })
        }

        drawTextBox = (sx, sy, w, h, color, text, fontSize, fcolor, align = "left") => {

            if (align == "left") {
                tx = sx * cm + fontSize / 3;
                ty = sy * cm + fontSize / 2;
            }
            else if (align == "center") {
                tx = sx * cm + (w / 2);
                ty = sy * cm + h / 2 - fontSize / 3;
            }

            page.drawRectangle({
                x: sx * cm,
                y: sy * cm,
                width: w * cm,
                height: h * cm,
                color: color,
                borderColor: rgb(0, 0, 0),
                borderWidth: 1.0,
            });
            page.drawText(text, {
                x: tx,
                y: ty,
                size: fontSize,
                // font: timesRomanFont,
                color: fcolor
            })
        }
        drawRTextBox = (sx, sy, w, h, color, text, fontSize, fcolor, align = "left") => {

            if (align == "left") {
                tx = orix + sx * cm + fontSize / 3;
                ty = oriy + sy * cm + fontSize / 2;
            }
            else if (align == "center") {
                tx = orix + sx * cm + (w * cm / 2);
                ty = oriy + sy * cm + (h * cm / 2) - fontSize / 3;
            }

            page.drawRectangle({
                x: orix + sx * cm,
                y: oriy + sy * cm,
                width: w * cm,
                height: h * cm,
                color: color,
                borderColor: rgb(0, 0, 0),
                borderWidth: 1.0,
            });
            page.drawText(text, {
                x: tx,
                y: ty,
                size: fontSize,
                // font: timesRomanFont,
                color: fcolor
            })
        }
    </script>
</body>

</html>